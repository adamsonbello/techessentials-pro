# TechEssentials Pro - API .htaccess Configuration
# @author Adams (Fred) - CTO
# @version 2.0
# @date 2025-09-16

# Empêcher l'accès direct aux fichiers PHP (sauf index.php)
<FilesMatch "\.(php)$">
    Order Deny,Allow
    Deny from all
</FilesMatch>

<Files "index.php">
    Order Allow,Deny
    Allow from all
</Files>

# Activer la réécriture d'URLs
RewriteEngine On

# Headers de sécurité
Header always set X-Content-Type-Options nosniff
Header always set X-Frame-Options SAMEORIGIN
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"

# Headers CORS (développement uniquement)
<IfModule mod_env.c>
    SetEnv DEVELOPMENT 1
</IfModule>

# En production, configurer les domaines spécifiques
# Header always set Access-Control-Allow-Origin "https://techessentialspro.com"
Header always set Access-Control-Allow-Origin "*"
Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-API-Token"
Header always set Access-Control-Max-Age "3600"

# Gérer les requêtes OPTIONS (preflight)
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^(.*)$ index.php [QSA,L]

# Rediriger toutes les requêtes vers index.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.php?route=$1 [QSA,L]

# Optimisations de performance
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType application/json "access plus 0 seconds"
</IfModule>

# Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE text/plain
</IfModule>

# Désactiver les logs d'accès pour l'API (optionnel)
# CustomLog /dev/null common

# Limites de taille des requêtes
LimitRequestBody 10485760  # 10MB

# Protection contre les attaques
<IfModule mod_evasive24.c>
    DOSHashTableSize 4096
    DOSPageCount 3
    DOSPageInterval 1
    DOSSiteCount 50
    DOSSiteInterval 1
    DOSBlockingPeriod 600
</IfModule>

# Bloquer les bots malveillants
<RequireAll>
    Require all granted
    Require not env bad_bot
</RequireAll>

SetEnvIfNoCase User-Agent "BadBot|MaliciousScanner|AttackBot" bad_bot

# Cacher les détails du serveur
ServerTokens Prod
ServerSignature Off

# Protection des fichiers sensibles
<Files ~ "^\.">
    Order allow,deny
    Deny from all
</Files>

<FilesMatch "(config|functions)\.php$">
    Order deny,allow
    Deny from all
</FilesMatch>

# Désactiver l'exécution de PHP dans les dossiers d'upload
<Directory "../uploads">
    php_flag engine off
</Directory>

# Configuration du cache
<IfModule mod_headers.c>
    # Cache pour les erreurs 404
    <FilesMatch "\.(json)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
</IfModule>

# Logging personnalisé pour l'API
<IfModule mod_log_config.c>
    LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %D" api_combined
    
    # En production, utiliser un fichier de log séparé
    # CustomLog ${APACHE_LOG_DIR}/api_access.log api_combined
</IfModule>

# Protection contre les injections
<IfModule mod_rewrite.c>
    # Bloquer les tentatives d'injection SQL courantes
    RewriteCond %{QUERY_STRING} (union.*select|select.*union) [NC]
    RewriteRule .* - [F,L]
    
    # Bloquer les tentatives XSS
    RewriteCond %{QUERY_STRING} (<|>|'|%0A|%0D|%27|%3C|%3E|%00) [NC]
    RewriteRule .* - [F,L]
    
    # Bloquer les tentatives d'inclusion de fichiers
    RewriteCond %{QUERY_STRING} (\.\.\/|\.\.\\|file:|ftp:|php://|http://|https://) [NC]
    RewriteRule .* - [F,L]
</IfModule>

# Limitation du débit (si disponible)
<IfModule mod_throttle.c>
    ThrottlePolicy Speed 50000
    ThrottleClientIP 5
</IfModule>

# Configuration spécifique pour les requêtes JSON
<LocationMatch "^/api">
    SetEnvIf Content-Type "application/json" json_request
</LocationMatch>

# Empêcher l'accès aux backups et fichiers temporaires
<FilesMatch "(\.(bak|old|tmp|swp|~)|#.*#)$">
    Order deny,allow
    Deny from all
</FilesMatch>